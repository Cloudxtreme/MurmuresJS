<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MurmuresJS</title>
    <link rel="stylesheet" href="src/css/client.css" media="screen">
</head>
<body onload="initLevel()">
    <div style="position:fixed; bottom:0; left:0; z-index:9999">
        <div id="debugDiv"></div>
    </div>

    <script src="src/character.js"></script>
    <script src="src/level.js"></script>
    <script type="text/javascript">
        'use strict';

        function sendAjax(path, param, callback, async) {
            let xhr = new XMLHttpRequest();
            xhr.open('POST', window.location.href + path, async);
            xhr.setRequestHeader('Content-Type', 'application/json');
            if (callback !== null) {
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        callback(xhr.responseText);
                    }
                };
            }
            xhr.send(param);
        }

        function renderLevel(srcJson) {
            let allCanvas = document.getElementsByTagName("canvas");
            for (let canvasIter = 0; canvasIter < allCanvas.length; canvasIter++) {
                allCanvas[canvasIter].width = 1401; // This is a hard reset of all canvas and is quite time consumming.
                allCanvas[canvasIter].height = 841;
                let context = allCanvas[canvasIter].getContext('2d');
                context.translate(0.5, 0.5); // translation prevents anti-aliasing.
            }
            let level1 = new level();
            level1.fromJson(JSON.parse(srcJson));
            drawGrid(level1);
            drawTiles(level1);
            drawCharacters(level1);
        }

        function drawCharacters(level) {
            /// <param name="level" type="level"/>
            let layer = document.getElementById('tilesLayer');
            let context = layer.getContext('2d');
            let img = new Image();
            img.onload = function () {
                context.drawImage(img, level.hero.position.x * level.tileSize, level.hero.position.y * level.tileSize, level.tileSize, level.tileSize);
            }
            img.src = level.hero.img;
        }

        function drawGrid(level) {
            /// <param name="level" type="level"/>
            let layer = document.getElementById('gridLayer');
            let context = layer.getContext('2d');
            context.clearRect(-0.5, -0.5, layer.width, layer.height);
            for (let x = 0; x < level.width; x++) {
                for (let y = 0; y < level.height; y++) {
                    drawOneSquare(context, level, x, y, "#ccc", false); // light gray
                }
            }
        }

        function drawOneSquare(context, level, x, y, color, filled) {
            /// <param name="level" type="level"/>
            context.beginPath();
            if (filled || y === 0) {
                context.moveTo(level.tileSize * x, level.tileSize * y);
                context.lineTo(level.tileSize * x + level.tileSize, level.tileSize * y);
            }
            else {
                context.moveTo(level.tileSize * x + level.tileSize, level.tileSize * y);
            }
            context.lineTo(level.tileSize * x + level.tileSize, level.tileSize * y + level.tileSize);
            context.lineTo(level.tileSize * x, level.tileSize * y + level.tileSize);
            if (filled || x === 0) {
                context.lineTo(level.tileSize * x, level.tileSize * y);
            }
            context.strokeStyle = color;
            context.stroke();
            if (filled) {
                context.closePath();
                context.fillStyle = color;
                context.fill();
            }
        }

        function drawTiles(level) {
            /// <param name="level" type="level"/>
            let layer = document.getElementById('tilesLayer');
            let context = layer.getContext('2d');
            context.clearRect(-0.5, -0.5, layer.width, layer.height);
            for (let x = 0; x < level.width; x++) {
                for (let y = 0; y < level.height; y++) {
                    drawOneTile(context, level, x, y, "#003");
                }
            }
        }

        function drawOneTile(context, level, x, y, color) {
            /// <param name="level" type="level"/>
            if ((x === 0) || (y === 0) || (x === level.width - 1) || (y === level.height - 1)) {
                drawOneSquare(context, level, x, y, color, true);
            }
            else {
                if (level.tiles[y][x] === 1) {
                    drawOneSquare(context, level, x, y, color, true);
                }
            }
        }

        function initLevel() {
            sendAjax('getLevel', '{"id":"level1"}', (response) => renderLevel(response), true);
            registerEvents()
        }

        function registerEvents() {
            // IE11 returns decimal number for MouseEvent coordinates but Chrome43 always rounds down.
            // --> using floor() for consistency.
            // Also, rounding cancels the canvas shift (0.5 pixel)
            // and retrieves the nearest pixel coordinates.
            let topLayer = document.getElementById("topLayer");
            let canvasCssTop = window.getComputedStyle(topLayer, null).getPropertyValue("top").slice(0, -2); // slice to remove the "px" part of the CSS property
            let canvasCssLeft = window.getComputedStyle(topLayer, null).getPropertyValue("left").slice(0, -2);
            topLayer.addEventListener("mousedown", function () {
                event.preventDefault(); // usually, keeping the left mouse button down triggers a text selection or a drag & drop.
                let mouseX = Math.floor(event.pageX) - parseInt(canvasCssLeft);
                let mouseY = Math.floor(event.pageY) - parseInt(canvasCssTop);
                topLayer_onClick(mouseX, mouseY, event.button == 2);
            }, false);
        }

        /// If left click --> selects one unit on the grid.
        /// If right click --> gives an order to the selected unit.
        function topLayer_onClick(mouseEventX, mouseEventY, rightClick) {
            if (!rightClick) {
                // event is a left click
                // find hovered tile
                let hoveredTile = getHoveredTile(mouseEventX, mouseEventY);
            }
            else {
                // event is a right click
                let hoveredTile = getHoveredTile(mouseEventX, mouseEventY);
            }
        }

        function getHoveredTile(mouseEventX, mouseEventY) {
            let tileX = Math.floor(mouseEventX / 32.0);
            let tileY = Math.floor(mouseEventY / 32.0);
            document.getElementById('debugDiv').innerHTML = ''.concat(tileX, ' ', tileY);
        }

    </script>
    <div id="fullScreen" style="position:absolute; top:0; left:0; width:100%; height:100%; background-color:#f8f8f8; z-index:-20"></div>
    <div id="iPhone6" style="position:absolute; top:0; left:0; width:1334px; height:750px; background-color:#f8fff8; z-index:-10"></div>
    <div id="iPhone5" style="position:absolute; top:0; left:0; width:1136px; height:640px; background-color:#f8f8ff; z-index:-9"></div>
    <div id="iPhone4" style="position:absolute; top:0; left:0; width:960px; height:640px; background-color:#fff8f8; z-index:-8"></div>
    <div id="galaxyS3Mini" style="position:absolute; top:0; left:0; width:800px; height:480px; background-color:#fff; z-index:-7"></div>

    <div id="targetResolution1" style="position:absolute; top:0; left:0; width:1136px; height:640px; z-index:-1">
        <div id="p1" style="clear:right; float:right; width:240px; height:200px; border:1px solid #000; margin:2px">Rat</div>
        <div id="p2" style="clear:right; float:right; width:240px; height:200px; border:1px solid #000; margin:2px">Chauve-souris</div>
    </div>
    <div id="targetResolution2" style="position:absolute; top:0; left:0; width:1136px; height:640px; z-index:-1">
        <div id="p4" style="clear:left; float:left; width:240px; height:200px; border:1px solid #000; margin:2px">Rincevent</div>
        <div id="p3" style="clear:left; float:left; width:240px; height:200px; border:1px solid #000; margin:2px; position:relative">
            <div style="position:absolute; width:3px; left:2px; height:196px; top:2px; background-color:#888;"></div>
            <div style="position:absolute; width:3px; left:2px; height:158px; top:40px; background-color:#d00;"></div>
            <div style="position:absolute; width:64px; left:7px; height:64px; top:2px; background-color:#ccc;">
                <img src="./src/img/perso.png">
            </div>
            <div style="position:absolute; width:150px; left:75px; height:64px; top:5px; font-size:20px; text-align: center;">Angharad</div>
            <div style="position:absolute; width:150px; left:75px; height:64px; top:35px; font-size:14px; text-align: center;">12/26</div>
            <div style="position:absolute; width:64px; left:7px; height:64px; top:68px; background-color:#ccf;"></div>
            <div style="position:absolute; width:64px; left:7px; height:64px; top:134px; background-color:#ccf;"></div>
            <div style="position:absolute; width:64px; left:88px; height:64px; top:68px; background-color:#ccf;"></div>
            <div style="position:absolute; width:64px; left:88px; height:64px; top:134px; background-color:#ccf;"></div>
            <div style="position:absolute; width:64px; left:169px; height:64px; top:68px; background-color:#ccf;"></div>
            <div style="position:absolute; width:64px; left:169px; height:64px; top:134px; background-color:#ccf;"></div>
        </div>
        <div id="p5" style="clear:left; float:left; width:240px; height:200px; border:1px solid #000; margin:2px">Kerrigan</div>
    </div>

    <button type="button" onclick="initLevel()" style="display:none">Get level</button>

    <canvas id="topLayer" width="1400" height="840" style="z-index: 999"></canvas>
    <canvas id="tilesLayer" width="1400" height="840" style="z-index: 20"></canvas>
    <canvas id="gridLayer" width="1400" height="840" style="z-index: 15"></canvas>

</body>
</html>
