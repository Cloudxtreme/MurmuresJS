<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MurmuresJS</title>
    <link rel="stylesheet" href="static/client.css" media="screen">
</head>
<body>
    <script src="static/character.js"></script>
    <script src="static/level.js"></script>
    <script type="text/javascript">
        'use strict';

        function sendAjax(path, param, callback, async) {
            let xhr = new XMLHttpRequest();
            xhr.open('POST', window.location.href + path, async);
            xhr.setRequestHeader('Content-Type', 'application/json');
            if (callback !== null) {
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        callback(xhr.responseText);
                    }
                };
            }
            xhr.send(param);
        }

        function renderLevel(level) {
            let allCanvas = document.getElementsByTagName("canvas");
            for (let canvasIter = 0; canvasIter < allCanvas.length; canvasIter++) {
                allCanvas[canvasIter].width = 1401; // This is a hard reset of all canvas and is quite time consumming.
                allCanvas[canvasIter].height = 841;
                let context = allCanvas[canvasIter].getContext('2d');
                context.translate(0.5, 0.5); // translation prevents anti-aliasing.
            }
            drawGrid(level);
            drawTiles(level);
        }

        function renderPosition(pos){
          let layer = document.getElementById('gridLayer');
          let context = layer.getContext('2d');
          let img = new Image();
          img.onload = function () {
              context.drawImage(img, pos.position.x*32, pos.position.y*32, 32, 32);
          }
          img.src = pos.img;
        //   context.drawImage(img, 64, 64, pos.position.x*64, pos.position.y*64);
        }

        function drawGrid(level) {
            let layer = document.getElementById('gridLayer');
            let context = layer.getContext('2d');
            context.clearRect(-0.5, -0.5, layer.width, layer.height);
            for (let x = 0; x < level.width; x++) {
                for (let y = 0; y < level.height; y++) {
                    drawOneSquare(context, level, x, y, "#ccc", false); // light gray
                }
            }
        }

        function drawOneSquare(context, level, x, y, color, filled) {
            context.beginPath();
            if (filled || y === 0) {
                context.moveTo(level.tileSize * x, level.tileSize * y);
                context.lineTo(level.tileSize * x + level.tileSize, level.tileSize * y);
            }
            else {
                context.moveTo(level.tileSize * x + level.tileSize, level.tileSize * y);
            }
            context.lineTo(level.tileSize * x + level.tileSize, level.tileSize * y + level.tileSize);
            context.lineTo(level.tileSize * x, level.tileSize * y + level.tileSize);
            if (filled || x === 0) {
                context.lineTo(level.tileSize * x, level.tileSize * y);
            }
            context.strokeStyle = color;
            context.stroke();
            if (filled) {
                context.closePath();
                context.fillStyle = color;
                context.fill();
            }
        }

        function drawTiles(level) {
            let layer = document.getElementById('tilesLayer');
            let context = layer.getContext('2d');
            context.clearRect(-0.5, -0.5, layer.width, layer.height);
            for (let x = 0; x < level.width; x++) {
                for (let y = 0; y < level.height; y++) {
                    drawOneTile(context, level, x, y, "#003");
                }
            }
        }

        function drawOneTile(context, level, x, y, color) {
            if ((x === 0) || (y === 0) || (x === level.width - 1) || (y === level.height - 1)) {
                drawOneSquare(context, level, x, y, color, true);
            }
            else {
                if (level.tiles[y][x] === 1) {
                    drawOneSquare(context, level, x, y, color, true);
                }
            }
        }

    </script>
    <div id="iPhone6" style="position:absolute; top:0; left:0; width:1334px; height:750px; background-color:#cfc; z-index:-2"></div>
    <div id="iPhone5" style="position:absolute; top:0; left:0; width:1136px; height:640px; background-color:white; z-index:-1"></div>
    <button type="button" onclick="sendAjax('getLevel', '{&quot;id&quot;:&quot;level1&quot;}', (response) => renderLevel(JSON.parse(response)), true);sendAjax('getPosition', '{&quot;id&quot;:&quot;1&quot;}', (response) => renderPosition(JSON.parse(response)), true)">Get level</button>

    <canvas id="tilesLayer" width="1400" height="840" style="z-index: 20"></canvas>
    <canvas id="gridLayer" width="1400" height="840" style="z-index: 15"></canvas>

</body>
</html>
