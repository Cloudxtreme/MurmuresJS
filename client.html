<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MurmuresJS</title>
    <link rel="stylesheet" href="src/css/client.css" media="screen">
</head>
<body onload="init()">
    <div style="position:fixed; bottom:0; left:0; z-index:9999">
        <div id="debugDiv"></div>
    </div>
    <script type="text/javascript">
        'use strict';
        // namespace
        var murmures = {}; 
    </script>
    <script src="src/character.js"></script>
    <script src="src/level.js"></script>
    <script src="src/order.js"></script>
    <script src="src/tile.js"></script>
    <script src="src/gameEngine.js"></script>

    <script type="text/javascript">
        'use strict';
        var gameEngine = new murmures.gameEngine();

        function onScreenLog(txt) {
            let now = new Date();
            document.getElementById("onScreenLog").innerHTML = '<span style="color:#ffa">' + now.toLocaleTimeString() + '.' + ('00' + now.getMilliseconds().toString()).substr(-3) + '</span> ' + txt + '<br/>' + document.getElementById("onScreenLog").innerHTML;
        }

        function sendAjax(path, param, callback, async) {
            let xhr = new XMLHttpRequest();
            xhr.open('POST', window.location.href + path, async);
            xhr.setRequestHeader('Content-Type', 'application/json');
            if (callback !== null) {
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        callback(xhr.responseText);
                    }
                };
            }
            xhr.send(param);
        }

        // #region Renderer
        function renderLevel(src) {
            /// <param name="src" type="level"/>
            let allCanvas = document.getElementsByTagName("canvas");
            for (let canvasIter = 0; canvasIter < allCanvas.length; canvasIter++) {
                allCanvas[canvasIter].width = 1401; // This is a hard reset of all canvas and is quite time consumming.
                allCanvas[canvasIter].height = 841;
                let context = allCanvas[canvasIter].getContext('2d');
                context.translate(0.5, 0.5); // translation prevents anti-aliasing.
            }
            let level1 = new murmures.level();
            level1.fromJson(src);
            drawGrid(level1);
            drawTiles(level1);
        }

        function clearCharacterLayer() {
            let layer = document.getElementById('characterLayer');
            let context = layer.getContext('2d');
            context.clearRect(-0.5, -0.5, layer.width, layer.height);
            context.imageSmoothingEnabled = false;
        }

        function drawCharacters(hero) {
            /// <param name="hero" type="hero"/>
            let layer = document.getElementById('characterLayer');
            let context = layer.getContext('2d');
            let img = new Image();
            img.onload = function () {
                context.drawImage(img, hero.position.x * gameEngine.tileSize, hero.position.y * gameEngine.tileSize, gameEngine.tileSize, gameEngine.tileSize);
            };
            img.src = hero.img;
        }

        function drawGrid(level) {
            /// <param name="level" type="level"/>
            let layer = document.getElementById('gridLayer');
            let context = layer.getContext('2d');
            context.clearRect(-0.5, -0.5, layer.width, layer.height);
            for (let x = 0; x < level.width; x++) {
                for (let y = 0; y < level.height; y++) {
                    drawOneSquare(context, level, x, y, "#ccc", false); // light gray
                }
            }
        }

        function drawOneSquare(context, level, x, y, color, filled) {
            /// <param name="level" type="level"/>
            context.beginPath();
            if (filled || y === 0) {
                context.moveTo(gameEngine.tileSize * x, gameEngine.tileSize * y);
                context.lineTo(gameEngine.tileSize * x + gameEngine.tileSize, gameEngine.tileSize * y);
            }
            else {
                context.moveTo(gameEngine.tileSize * x + gameEngine.tileSize, gameEngine.tileSize * y);
            }
            context.lineTo(gameEngine.tileSize * x + gameEngine.tileSize, gameEngine.tileSize * y + gameEngine.tileSize);
            context.lineTo(gameEngine.tileSize * x, gameEngine.tileSize * y + gameEngine.tileSize);
            if (filled || x === 0) {
                context.lineTo(gameEngine.tileSize * x, gameEngine.tileSize * y);
            }
            context.strokeStyle = color;
            context.stroke();
            if (filled) {
                context.closePath();
                context.fillStyle = color;
                context.fill();
            }
        }

        function drawTiles(level) {
            /// <param name="level" type="level"/>
            let layer = document.getElementById('tilesLayer');
            let context = layer.getContext('2d');
            context.clearRect(-0.5, -0.5, layer.width, layer.height);
            for (let x = 0; x < level.width; x++) {
                for (let y = 0; y < level.height; y++) {
                    drawOneTile(context, level, x, y, "#2D1E19");
                }
            }
        }

        function drawOneTile(context, level, x, y, color) {
            /// <param name="level" type="level"/>
            if ((x === 0) || (y === 0) || (x === level.width - 1) || (y === level.height - 1)) {
                drawOneSquare(context, level, x, y, color, true);
            }
            else {
                if (level.tiles[y][x] === 1) {
                    drawOneSquare(context, level, x, y, color, true);
                }
            }
        }
        // #endregion

        function init() {
            onScreenLog('>> getLevel');
            sendAjax('getLevel', '{"id":"level1"}', loadEngine, true);
            registerEvents();
        }

        function loadEngine(engine) {
            onScreenLog('<< loadEngine');
            gameEngine.fromJson(JSON.parse(engine));
            renderLevel(gameEngine.level);
            clearCharacterLayer();
            drawCharacters(gameEngine.hero);
            gameEngine.mobs.forEach((mob) =>drawCharacters(mob));
        }

        function registerEvents() {
            // IE11 returns decimal number for MouseEvent coordinates but Chrome43 always rounds down.
            // --> using floor() for consistency.
            // Also, rounding cancels the canvas shift (0.5 pixel)
            // and retrieves the nearest pixel coordinates.
            let topLayer = document.getElementById("topLayer");
            topLayer.addEventListener("mousedown", function (e) {
                e.preventDefault(); // usually, keeping the left mouse button down triggers a text selection or a drag & drop.
                let mouseX = Math.floor(e.offsetX);
                let mouseY = Math.floor(e.offsetY);
                topLayer_onClick(mouseX, mouseY, e.button == 2);
            }, false);
            window.addEventListener("keypress", function (e) {
                let char = '';
                if (e.which == null)
                    char = String.fromCharCode(e.keyCode);
                else
                    char = String.fromCharCode(e.which);
                onKeyPress(char);
            }, false);
        }

        function topLayer_onClick(mouseEventX, mouseEventY, rightClick) {
            if (!rightClick) {
                // event is a left click
                // find hovered tile
                let hoveredTile = getHoveredTile(mouseEventX, mouseEventY);
                let moveOrder = new murmures.order();
                moveOrder.command = "move";
                moveOrder.source = gameEngine.hero;
                moveOrder.target = hoveredTile;
                launchOrder(moveOrder);
            }
            else {
                // event is a right click
                let hoveredTile = getHoveredTile(mouseEventX, mouseEventY);
            }
        }

        function getHoveredTile(mouseEventX, mouseEventY) {
            let tileX = Math.floor(mouseEventX / gameEngine.tileSize);
            let tileY = Math.floor(mouseEventY / gameEngine.tileSize);
            document.getElementById('debugDiv').innerHTML = ''.concat(tileX, ' ', tileY);
            let ret = new murmures.tile();
            ret.x = tileX;
            ret.y = tileY;
            return ret;
        }

        function onKeyPress(char) {
            let allowedChars = '12346789';
            if (allowedChars.indexOf(char) >= 0) {
                let moveOrder = new murmures.order();
                moveOrder.command = "move";
                moveOrder.source = gameEngine.hero;
                let target = new murmures.tile();
                if (char === '9' || char === '6' || char === '3') target.x = gameEngine.hero.position.x + 1;
                if (char === '7' || char === '4' || char === '1') target.x = gameEngine.hero.position.x - 1;
                if (char === '8' || char === '2') target.x = gameEngine.hero.position.x;
                if (char === '9' || char === '8' || char === '7') target.y = gameEngine.hero.position.y - 1;
                if (char === '3' || char === '2' || char === '1') target.y = gameEngine.hero.position.y + 1;
                if (char === '4' || char === '6') target.y = gameEngine.hero.position.y;
                moveOrder.target = target;
                launchOrder(moveOrder);
            }
            else {
                onScreenLog('<span style="color:#f66">' + 'ERROR - This is not a valid key</span>');
            }
        }

        function launchOrder(order) {
            let check = gameEngine.checkOrder(order);
            if (check.valid) {
                onScreenLog('>> order (move)');
                sendAjax('order', JSON.stringify(order), updateCharacters, true);
            }
            else {
                onScreenLog('<span style="color:#f66">' + 'ERROR - invalid order - ' + check.reason + '</span>');
            }
        }

        function updateCharacters(response) {
            onScreenLog('<< updateCharacters');
            let ge = JSON.parse(response);
            gameEngine.hero = ge.hero;
            gameEngine.mobs = ge.mobs;
            clearCharacterLayer();
            drawCharacters(gameEngine.hero);
            gameEngine.mobs.forEach((mob) =>drawCharacters(mob));
        }

    </script>
    <!--
    <div id="fullScreen" style="position:absolute; top:0; left:0; width:100%; height:100%; background-color:#f8f8f8; z-index:-20"></div>
    <div id="iPhone6" style="position:absolute; top:0; left:0; width:1334px; height:750px; background-color:#f8fff8; z-index:-10"></div>
    <div id="iPhone5" style="position:absolute; top:0; left:0; width:1136px; height:640px; background-color:#f8f8ff; z-index:-9"></div>
    <div id="iPhone4" style="position:absolute; top:0; left:0; width:960px; height:640px; background-color:#fff8f8; z-index:-8"></div>
    <div id="galaxyS3Mini" style="position:absolute; top:0; left:0; width:800px; height:480px; background-color:#fff; z-index:-7"></div>
    -->
    <div id="targetResolution" class="fullScreen">
        <div id="rightCharacters" class="zUI" style="float:right">
            <div id="p1" style="clear:left; float:left; border:1px solid #666; border-radius:4px; margin:2px; padding:3px; background-color:#4C2A2A">
                <div style="float:left; margin:3px; width:5px; height:208px; background-color:#d00;">
                    <div style="height:40px; background-color:#888; margin:0"></div>
                </div>
                <div style="float:left">
                    <div style="float:left; margin:3px; background-color:#000;">
                        <img class="uiIcon" src="./src/img/perso.png">
                    </div>
                    <div style="float:left; width: 192px; margin:3px; padding:5px;">
                        <div style="margin:3px; text-align: center;">Rat</div>
                        <div style="margin:3px; font-size:smaller; text-align: center;"></div>
                    </div>
                    <div style="clear:left; float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="clear:left; float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                </div>
            </div>
            <div id="p2" style="clear:left; float:left; border:1px solid #666; border-radius:4px; margin:2px; padding:3px; background-color:#4C2A2A">
                <div style="float:left; margin:3px; width:5px; height:208px; background-color:#d00;">
                    <div style="height:40px; background-color:#888; margin:0"></div>
                </div>
                <div style="float:left">
                    <div style="float:left; margin:3px; background-color:#000;">
                        <img class="uiIcon" src="./src/img/perso.png">
                    </div>
                    <div style="float:left; width: 192px; margin:3px; padding:5px;">
                        <div style="margin:3px; text-align: center;">Chauve-souris</div>
                        <div style="margin:3px; font-size:smaller; text-align: center;"></div>
                    </div>
                    <div style="clear:left; float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="clear:left; float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                </div>
            </div>
        </div>
        <div id="leftCharacters" class="zUI" style="float:left">
            <div id="p3" style="clear:left; float:left; border:1px solid #666; border-radius:4px; margin:2px; padding:3px; background-color:#2c3e50">
                <div style="float:left; margin:3px; width:5px; height:208px; background-color:#d00;">
                    <div style="height:40px; background-color:#888; margin:0"></div>
                </div>
                <div style="float:left">
                    <div style="float:left; margin:3px; background-color:#000;">
                        <img class="uiIcon" src="./src/img/perso.png">
                    </div>
                    <div style="float:left; width: 192px; margin:3px; padding:5px;">
                        <div style="margin:3px; text-align: center;">Angharad</div>
                        <div style="margin:3px; font-size:smaller; text-align: center;">12/26</div>
                    </div>
                    <div style="clear:left; float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="clear:left; float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                </div>
            </div>
            <div id="p4" style="clear:left; float:left; border:1px solid #666; border-radius:4px; margin:2px; padding:3px; background-color:#2c3e50">
                <div style="float:left; margin:3px; width:5px; height:208px; background-color:#d00;">
                    <div style="height:40px; background-color:#888; margin:0"></div>
                </div>
                <div style="float:left">
                    <div style="float:left; margin:3px; background-color:#000;">
                        <img class="uiIcon" src="./src/img/perso.png">
                    </div>
                    <div style="float:left; width: 192px; margin:3px; padding:5px;">
                        <div style="margin:3px; text-align: center;">Rincevent</div>
                        <div style="margin:3px; font-size:smaller; text-align: center;">12/26</div>
                    </div>
                    <div style="clear:left; float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="clear:left; float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                </div>
            </div>
            <div id="p5" style="clear:left; float:left; border:1px solid #666; border-radius:4px; margin:2px; padding:3px; background-color:#2c3e50">
                <div style="float:left; margin:3px; width:5px; height:208px; background-color:#d00;">
                    <div style="height:40px; background-color:#888; margin:0"></div>
                </div>
                <div style="float:left">
                    <div style="float:left; margin:3px; background-color:#000;">
                        <img class="uiIcon" src="./src/img/perso.png">
                    </div>
                    <div style="float:left; width: 192px; margin:3px; padding:5px;">
                        <div style="margin:3px; text-align: center;">Kerrigan</div>
                        <div style="margin:3px; font-size:smaller; text-align: center;">12/26</div>
                    </div>
                    <div style="clear:left; float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="clear:left; float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                    <div style="float:left; margin:3px; width:64px; height:64px; background-color:#ccf;"></div>
                </div>
            </div>
        </div>
    </div>

    <button type="button" onclick="init()" style="display:none">Get level</button>

    <div style="float:left; position:relative;">
        <canvas id="topLayer" width="1400" height="840" style="z-index: 99"></canvas>
        <canvas id="gridLayer" width="1400" height="840" style="z-index: 25; opacity:0.2"></canvas>
        <canvas id="characterLayer" width="1400" height="840" style="z-index: 20"></canvas>
        <canvas id="tilesLayer" width="1400" height="840" style="z-index: 15"></canvas>
        <code id="onScreenLog" style="position:relative; top:400px; margin:2px 7px; width:636px; height:300px; z-index:9999; color:white; overflow:auto; display: block;"></code>
    </div>


</body>
</html>
