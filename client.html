<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MurmuresJS</title>
    <link rel="stylesheet" href="src/css/client.css" media="screen">
</head>
<body onload="initLevel()">
    <script src="src/character.js"></script>
    <script src="src/level.js"></script>
    <script type="text/javascript">
        'use strict';

        function sendAjax(path, param, callback, async) {
            let xhr = new XMLHttpRequest();
            xhr.open('POST', window.location.href + path, async);
            xhr.setRequestHeader('Content-Type', 'application/json');
            if (callback !== null) {
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        callback(xhr.responseText);
                    }
                };
            }
            xhr.send(param);
        }

        function renderLevel(level) {
            let allCanvas = document.getElementsByTagName("canvas");
            for (let canvasIter = 0; canvasIter < allCanvas.length; canvasIter++) {
                allCanvas[canvasIter].width = 1401; // This is a hard reset of all canvas and is quite time consumming.
                allCanvas[canvasIter].height = 841;
                let context = allCanvas[canvasIter].getContext('2d');
                context.translate(0.5, 0.5); // translation prevents anti-aliasing.
            }
            drawGrid(level);
            drawTiles(level);
        }

        function renderPosition(pos) {
            let layer = document.getElementById('gridLayer');
            let context = layer.getContext('2d');
            let img = new Image();
            img.onload = function () {
                context.drawImage(img, pos.position.x * 32, pos.position.y * 32, 32, 32);
            }
            img.src = pos.img;
            //   context.drawImage(img, 64, 64, pos.position.x*64, pos.position.y*64);
        }

        function drawGrid(level) {
            let layer = document.getElementById('gridLayer');
            let context = layer.getContext('2d');
            context.clearRect(-0.5, -0.5, layer.width, layer.height);
            for (let x = 0; x < level.width; x++) {
                for (let y = 0; y < level.height; y++) {
                    drawOneSquare(context, level, x, y, "#ccc", false); // light gray
                }
            }
        }

        function drawOneSquare(context, level, x, y, color, filled) {
            context.beginPath();
            if (filled || y === 0) {
                context.moveTo(level.tileSize * x, level.tileSize * y);
                context.lineTo(level.tileSize * x + level.tileSize, level.tileSize * y);
            }
            else {
                context.moveTo(level.tileSize * x + level.tileSize, level.tileSize * y);
            }
            context.lineTo(level.tileSize * x + level.tileSize, level.tileSize * y + level.tileSize);
            context.lineTo(level.tileSize * x, level.tileSize * y + level.tileSize);
            if (filled || x === 0) {
                context.lineTo(level.tileSize * x, level.tileSize * y);
            }
            context.strokeStyle = color;
            context.stroke();
            if (filled) {
                context.closePath();
                context.fillStyle = color;
                context.fill();
            }
        }

        function drawTiles(level) {
            let layer = document.getElementById('tilesLayer');
            let context = layer.getContext('2d');
            context.clearRect(-0.5, -0.5, layer.width, layer.height);
            for (let x = 0; x < level.width; x++) {
                for (let y = 0; y < level.height; y++) {
                    drawOneTile(context, level, x, y, "#003");
                }
            }
        }

        function drawOneTile(context, level, x, y, color) {
            if ((x === 0) || (y === 0) || (x === level.width - 1) || (y === level.height - 1)) {
                drawOneSquare(context, level, x, y, color, true);
            }
            else {
                if (level.tiles[y][x] === 1) {
                    drawOneSquare(context, level, x, y, color, true);
                }
            }
        }

        function initLevel() {
            sendAjax('getLevel', '{"id":"level1"}', (response) => renderLevel(JSON.parse(response)), true);
            sendAjax('getPosition', '{"id":"1"}', (response) => renderPosition(JSON.parse(response)), true)
        }
    </script>
    <div id="fullScreen" style="position:absolute; top:0; left:0; width:100%; height:100%; background-color:#eee; z-index:-20"></div>
    <div id="iPhone6" style="position:absolute; top:0; left:0; width:1334px; height:750px; background-color:#dfd; z-index:-10"></div>
    <div id="iPhone5" style="position:absolute; top:0; left:0; width:1136px; height:640px; background-color:#ddf; z-index:-9"></div>
    <div id="iPhone4" style="position:absolute; top:0; left:0; width:960px; height:640px; background-color:#fdd; z-index:-8"></div>
    <div id="galaxyS3Mini" style="position:absolute; top:0; left:0; width:800px; height:480px; background-color:#fff; z-index:-7"></div>

    <div id="targetResolution1" style="position:absolute; top:0; left:0; width:1136px; height:640px; z-index:-1">
        <div id="p1" style="clear:right; float:right; width:240px; height:200px; border:1px solid #000; margin:2px">Rat</div>
        <div id="p2" style="clear:right; float:right; width:240px; height:200px; border:1px solid #000; margin:2px">Chauve-souris</div>
    </div>
    <div id="targetResolution2" style="position:absolute; top:0; left:0; width:1136px; height:640px; z-index:-1">
        <div id="p4" style="clear:left; float:left; width:240px; height:200px; border:1px solid #000; margin:2px">Rincevent</div>
        <div id="p3" style="clear:left; float:left; width:240px; height:200px; border:1px solid #000; margin:2px; position:relative">
            <div style="position:absolute; width:3px; left:2px; height:196px; top:2px; background-color:#888;"></div>
            <div style="position:absolute; width:3px; left:2px; height:158px; top:40px; background-color:#d00;"></div>
            <div style="position:absolute; width:64px; left:7px; height:64px; top:2px; background-color:#ccc;">
                <img src="./src/img/perso.png">
            </div>
            <div style="position:absolute; width:150px; left:75px; height:64px; top:5px; font-size:20px; text-align: center;">Angharad</div>
            <div style="position:absolute; width:150px; left:75px; height:64px; top:35px; font-size:14px; text-align: center;">12/26</div>
            <div style="position:absolute; width:64px; left:7px; height:64px; top:68px; background-color:#ccf;"></div>
            <div style="position:absolute; width:64px; left:7px; height:64px; top:134px; background-color:#ccf;"></div>
            <div style="position:absolute; width:64px; left:88px; height:64px; top:68px; background-color:#ccf;"></div>
            <div style="position:absolute; width:64px; left:88px; height:64px; top:134px; background-color:#ccf;"></div>
            <div style="position:absolute; width:64px; left:169px; height:64px; top:68px; background-color:#ccf;"></div>
            <div style="position:absolute; width:64px; left:169px; height:64px; top:134px; background-color:#ccf;"></div>
        </div>
        <div id="p5" style="clear:left; float:left; width:240px; height:200px; border:1px solid #000; margin:2px">Kerrigan</div>
    </div>

    <button type="button" onclick="initLevel()" style="display:none">Get level</button>

    <canvas id="tilesLayer" width="1400" height="840" style="z-index: 20"></canvas>
    <canvas id="gridLayer" width="1400" height="840" style="z-index: 15"></canvas>

</body>
</html>
