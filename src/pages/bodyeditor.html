<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MurmuresJS</title>
    <link rel="stylesheet" href="/src/css/client.css" media="screen">
    <style>
        body {
            background: #666;
            font-family: sans-serif;
        }

        #container {
            max-height: 100vh;
            overflow-y: scroll;
            width: 1558px;
        }

        p {
            display: table-row;
        }

        label {
            display: table-cell;
        }

        input {
            display: table-cell;
        }
    </style>
</head>
<body onload="initBodyEditor()">
    <div style="position:fixed; bottom:0; left:0; z-index:9999">
        <div id="debugDiv"></div>
    </div>
    <script type="text/javascript">
        'use strict';
        // namespace
        var murmures = {};
    </script>
    <script src="/src/js/core/constants.js"></script>
    <script src="/src/js/core/character.js"></script>
    <script src="/src/js/core/level.js"></script>
    <script src="/src/js/core/order.js"></script>
    <script src="/src/js/core/tile.js"></script>
    <script src="/src/js/core/gameengine.js"></script>
    <script src="/src/js/clientscript.js"></script>
    <script type="text/javascript">
        'use strict';

        function initBodyEditor() {
            sendAjax('/getLevel', '{"id":"level1"}', loadEngineBodyEditor, true);
        }

        function loadEngineBodyEditor(engine) {
            gameEngine.fromJson(JSON.parse(engine));
            tileset.addEventListener('mousedown', function (event) {
                let x = Math.floor(event.offsetX / gameEngine.tileSize / 0.75);
                let y = Math.floor(event.offsetY / gameEngine.tileSize / 0.75);
                let i = x + y * 64;
                for (let key in gameEngine.bodies) {
                    if (gameEngine.bodies[key].rank === i) {
                        let body = gameEngine.bodies[key];
                        document.getElementById('layerId').value = body.layerId;
                        document.getElementById('rank').value = body.rank;
                        document.getElementById('hasPhysics').checked = body.hasPhysics;
                        document.getElementById('allowFlying').checked = body.allowFlying;
                        document.getElementById('allowTerrestrial').checked = body.allowTerrestrial;
                        document.getElementById('allowAquatic').checked = body.allowAquatic;
                        document.getElementById('allowUnderground').checked = body.allowUnderground;
                        document.getElementById('allowEthereal').checked = body.allowEthereal;
                        document.getElementById('behavior').value = JSON.stringify(body.behavior);
                    }
                }
            });
            saveButton.addEventListener('mousedown', function (event) {
                let body = {};
                body.layerId = document.getElementById('layerId').value;
                body.rank = parseInt(document.getElementById('rank').value);
                body.hasPhysics = document.getElementById('hasPhysics').checked;
                if (body.hasPhysics) {
                    body.allowFlying = document.getElementById('allowFlying').checked;
                    body.allowTerrestrial = document.getElementById('allowTerrestrial').checked;
                    body.allowAquatic = document.getElementById('allowAquatic').checked;
                    body.allowUnderground = document.getElementById('allowUnderground').checked;
                    body.allowEthereal = document.getElementById('allowEthereal').checked;
                }
                body.behavior = JSON.parse(document.getElementById('behavior').value);
                gameEngine.bodies[body.uniqueId] = body;
            });
            dumpButton.addEventListener('mousedown', function (event) {
                //cleanup
                for (let key in gameEngine.bodies) {
                    let body = gameEngine.bodies[key];
                    //if (['31', '32', '33', '34', '35', '36', '37', '38', '39', '40', '41', '42', '43', '44'].indexOf(body.layerId) >= 0) {
                    //    body.isMob = true;
                    //}
                    //if (['56', ].indexOf(body.layerId) >= 0) {
                    //    body.isHero = true;
                    //}
                    if (!body.hasPhysics) delete body.hasPhysics;
                    if (!body.allowFlying) delete body.allowFlying;
                    if (!body.allowTerrestrial) delete body.allowTerrestrial;
                    if (!body.allowAquatic) delete body.allowAquatic;
                    if (!body.allowUnderground) delete body.allowUnderground;
                    if (!body.allowEthereal) delete body.allowEthereal;
                    if (JSON.stringify(body.behavior) === '{}') delete body.behavior;
                }
                document.getElementById("screenLog").innerHTML = JSON.stringify(gameEngine.bodies);
            });
        }

    </script>

    <div id="targetResolution" class="fullScreen">
        <div id="rightCharacters" style="position: fixed;right: 0; z-index:9999;">
            <div style="display: table;">
                <p><label>layerId</label><input type="text" id="layerId"></p>
                <p><label>rank</label><input type="text" id="rank" readonly></p>
                <p><label>hasPhysics</label><input type="checkbox" id="hasPhysics"></p>
                <p><label>allowFlying</label><input type="checkbox" id="allowFlying"></p>
                <p><label>allowTerrestrial</label><input type="checkbox" id="allowTerrestrial"></p>
                <p><label>allowAquatic</label><input type="checkbox" id="allowAquatic"></p>
                <p><label>allowUnderground</label><input type="checkbox" id="allowUnderground"></p>
                <p><label>allowEthereal</label><input type="checkbox" id="allowEthereal"></p>
                <p><label>behavior</label><input type="text" id="behavior"></p>
            </div>
            <button id="saveButton">Save</button>
            <button id="dumpButton">Dump</button>
        </div>
    </div>
    <div id="container">
        <img id="tileset" src="/src/img/murmures.png" style="width: 1536px;" />
    </div>
    <div id="screenLog" style="position:fixed; right:0; top:350px; margin:2px 7px; width:300px; height:calc(100vh - 350px); z-index:9999; color:#fff; overflow:auto; display: block;"></div>


</body>
</html>
