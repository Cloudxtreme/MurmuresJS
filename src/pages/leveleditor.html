<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MurmuresJS</title>
    <link rel="stylesheet" href="/src/css/client.css" media="screen">
    <style>
        body {
            background: #666;
            font-family: sans-serif;
        }

        #container {
            max-height: 60vh;
            overflow-y: scroll;
            width: 1000px;
        }

        p {
            display: table-row;
        }

        label {
            display: table-cell;
        }

        input {
            display: table-cell;
        }
    </style>
</head>
<body onload="initLevelEditor()">
    <div style="position:fixed; bottom:0; left:0; z-index:9999">
        <div id="debugDiv"></div>
    </div>
    <script type="text/javascript">
        'use strict';
        // namespace
        var murmures = {};
    </script>
    <script src="/src/constants.js"></script>
    <script src="/src/character.js"></script>
    <script src="/src/level.js"></script>
    <script src="/src/order.js"></script>
    <script src="/src/tile.js"></script>
    <script src="/src/gameEngine.js"></script>
    <script src="/src/clientScript.js"></script>
    <script type="text/javascript">
        'use strict';

        var selectedBrush = {
            id: 'rltiles_floor_of_a_room',
            layer: 'ground'
        };

        function initLevelEditor() {
            sendAjax('/getLevel', '{"id":"level1"}', loadEngineLevelEditor, true);
            registerEventsLevelEditor();
        }

        function loadEngineLevelEditor(engine) {
            gameEngine.fromJson(JSON.parse(engine));
            gameEngine.loadMobs();
            highlightLevel();
            initUILevelEditor();
            window.requestAnimationFrame(renderLevel);
        }

        function highlightLevel() {
            for (let x = 0; x < gameEngine.level.width; x++) {
                for (let y = 0; y < gameEngine.level.height; y++) {
                    gameEngine.level.tiles[y][x].state = murmures.C.TILE_HIGHLIGHTED;
                }
            }
        }

        function initUILevelEditor() {
            let tileUiTemplate = document.getElementById('tileUiTemplate').innerHTML;
            let templateStr = /template/g;
            document.getElementById('leftCharacters').innerHTML = '';
            document.getElementById('rightCharacters').innerHTML = '';
            document.getElementById('leftCharacters').insertAdjacentHTML('beforeend', '<h3>Grounds</h3>');
            for (let groundId in gameEngine.bodies) {
                let ref = gameEngine.bodies[groundId];
                if (ref.layer === 'ground') {
                    document.getElementById('leftCharacters').insertAdjacentHTML('beforeend', tileUiTemplate.replace(templateStr, 'grnd-' + groundId));
                    document.getElementById('grnd-' + groundId + '-icon').style.backgroundPosition = '-' + gameEngine.tileSize * ref.tilesetCoord[0] + 'px -' + gameEngine.tileSize * ref.tilesetCoord[1] + 'px';
                    document.getElementById('grnd-' + groundId + '-icon').addEventListener("mousedown", function (e) {
                        selectedBrush.id = groundId;
                        selectedBrush.layer = 'ground';
                        document.getElementById('selectedBrush' + '-icon').style.backgroundPosition = '-' + gameEngine.tileSize * ref.tilesetCoord[0] + 'px -' + gameEngine.tileSize * ref.tilesetCoord[1] + 'px';
                    }, false);
                }
            }
            document.getElementById('leftCharacters').insertAdjacentHTML('beforeend', '<br><h3>Props</h3>');
            for (let groundId in gameEngine.bodies) {
                let ref = gameEngine.bodies[groundId];
                if (ref.layer === 'prop') {
                    document.getElementById('leftCharacters').insertAdjacentHTML('beforeend', tileUiTemplate.replace(templateStr, 'prop-' + groundId));
                    document.getElementById('prop-' + groundId + '-icon').style.backgroundPosition = '-' + gameEngine.tileSize * ref.tilesetCoord[0] + 'px -' + gameEngine.tileSize * ref.tilesetCoord[1] + 'px';
                    document.getElementById('prop-' + groundId + '-icon').addEventListener("mousedown", function (e) {
                        selectedBrush.id = groundId;
                        selectedBrush.layer = 'prop';
                        document.getElementById('selectedBrush' + '-icon').style.backgroundPosition = '-' + gameEngine.tileSize * ref.tilesetCoord[0] + 'px -' + gameEngine.tileSize * ref.tilesetCoord[1] + 'px';
                    }, false);
                }
            }
            document.getElementById('leftCharacters').insertAdjacentHTML('beforeend', '<br><h3>Characters</h3>');
            for (let mobId in gameEngine.mobsReference) {
                let ref = gameEngine.mobsReference[mobId];
                document.getElementById('leftCharacters').insertAdjacentHTML('beforeend', tileUiTemplate.replace(templateStr, 'char-' + mobId));
                document.getElementById('char-' + mobId + '-icon').style.backgroundPosition = '-' + gameEngine.tileSize * ref.tilesetCoord[0] + 'px -' + gameEngine.tileSize * ref.tilesetCoord[1] + 'px';
                document.getElementById('char-' + mobId + '-icon').addEventListener("mousedown", function (e) {
                    selectedBrush.id = mobId;
                    selectedBrush.layer = 'char';
                    document.getElementById('selectedBrush' + '-icon').style.backgroundPosition = '-' + gameEngine.tileSize * ref.tilesetCoord[0] + 'px -' + gameEngine.tileSize * ref.tilesetCoord[1] + 'px';
                }, false);
            }
            document.getElementById('leftCharacters').insertAdjacentHTML('beforeend', '<br><h3>Selected</h3>');
            document.getElementById('leftCharacters').insertAdjacentHTML('beforeend', tileUiTemplate.replace(templateStr, 'selectedBrush'));
            let ref = selectedBrush.layer === 'char' ? gameEngine.mobsReference[selectedBrush.id] : gameEngine.bodies[selectedBrush.id];
            document.getElementById('selectedBrush' + '-icon').style.backgroundPosition = '-' + gameEngine.tileSize * ref.tilesetCoord[0] + 'px -' + gameEngine.tileSize * ref.tilesetCoord[1] + 'px';
            document.getElementById('leftCharacters').insertAdjacentHTML('beforeend', '<br><br><button id="exportButton">Export</button>');
            document.getElementById('exportButton').addEventListener("mousedown", function (e) {
                gameEngine.level.clean();
                document.getElementById("screenLog").innerHTML = '';
                screenLog(JSON.stringify(gameEngine.level));
                loadEngineLevelEditor(JSON.stringify(gameEngine));
            }, false);
            document.getElementById('rightCharacters').insertAdjacentHTML('beforeend',
                '<p><label>Id</label><input type="text" id="levelId"></p>' +
                '<p><label>Width</label><input type="text" id="levelWidth"></p>' +
                '<p><label>Height</label><input type="text" id="levelHeight"></p>' +
                '<br><button id="newLevel">New level</button>');
            document.getElementById('newLevel').addEventListener("mousedown", function (e) {
                let newLvl = new murmures.Level();
                newLvl.id = document.getElementById('levelId').value;
                newLvl.width = parseInt(document.getElementById('levelWidth').value);
                newLvl.height = parseInt(document.getElementById('levelHeight').value);
                newLvl.tileSize = gameEngine.level.tileSize;
                newLvl.layout = gameEngine.level.layout;
                newLvl.tiles = [];
                for (let y = 0; y < newLvl.height; y++) {
                    newLvl.tiles[y] = [];
                    for (let x = 0; x < newLvl.width; x++) {
                        newLvl.tiles[y][x] = new murmures.Tile();
                        if (selectedBrush.layer === 'char') newLvl.tiles[y][x].charId = selectedBrush.id;
                        else if (selectedBrush.layer === 'prop') newLvl.tiles[y][x].propId = selectedBrush.id;
                        else if (selectedBrush.layer === 'ground') newLvl.tiles[y][x].groundId = selectedBrush.id;
                    }
                }
                gameEngine.level = newLvl;
                loadEngineLevelEditor(JSON.stringify(gameEngine));
            }, false);
        }

        //override
        function updateUI() {
            clearCharacterLayer();
            for (let i = 0; i < gameEngine.mobs.length; i++) {
                drawCharacter(gameEngine.mobs[i]);
            }
            drawCharacter(gameEngine.hero);
        }

        function registerEventsLevelEditor() {
            let topLayer = document.getElementById("topLayer");
            topLayer.addEventListener("mousedown", function (e) {
                e.preventDefault(); // usually, keeping the left mouse button down triggers a text selection or a drag & drop.
                let mouseX = Math.floor(e.offsetX);
                let mouseY = Math.floor(e.offsetY);
                topLayer_onClickLevelEditor(mouseX, mouseY, e.button === 2);
            }, false);
            topLayer.addEventListener("contextmenu", function () { // mouse right click
                event.preventDefault();
            }, false);

        }

        function topLayer_onClickLevelEditor(mouseEventX, mouseEventY, rightClick) {
            if (!rightClick) {
                // event is a left click
                // find hovered tile
                let hoveredTile = getHoveredTile(mouseEventX, mouseEventY);
                if (selectedBrush.layer === 'char') hoveredTile.charId = selectedBrush.id;
                else if (selectedBrush.layer === 'prop') hoveredTile.propId = selectedBrush.id;
                else if (selectedBrush.layer === 'ground') hoveredTile.groundId = selectedBrush.id;
            }
            else {
                // event is a right click
                let hoveredTile = getHoveredTile(mouseEventX, mouseEventY);
                if (selectedBrush.layer === 'char') hoveredTile.charId = '';
                else if (selectedBrush.layer === 'prop') hoveredTile.propId = '';
                else if (selectedBrush.layer === 'ground') hoveredTile.groundId = '';
            }
            loadEngineLevelEditor(JSON.stringify(gameEngine));            
        }


    </script>

    <script type="text/html" id="tileUiTemplate">
        <div id="template-tileContainer" style="float:left">
            <div id="template-icon" class="uiIcon charIcon">
            </div>
        </div>
    </script>

    <div id="targetResolution" class="fullScreen">
        <div id="rightCharacters" class="zUI" style="float:right">
        </div>
        <div id="leftCharacters" class="zUI" style="float:left; width:166px">
        </div>
    </div>
    <img id="rltiles" src="/src/img/rltiles-2d.png" style="display:none">

    <div style="float:left; position:relative;">
        <canvas id="topLayer" width="1400" height="840" style="z-index: 99"></canvas>
        <canvas id="characterLayer" width="1400" height="840" style="z-index: 30"></canvas>
        <canvas id="fogOfWarLayer" width="1400" height="840" style="z-index: 25; opacity:0.5"></canvas>
        <canvas id="propsLayer" width="1400" height="840" style="z-index: 20"></canvas>
        <canvas id="tilesLayer" width="1400" height="840" style="z-index: 15"></canvas>
        <code id="screenLog" style="position:relative; top:400px; margin:2px 7px; width:636px; height:300px; z-index:9999; color:white; overflow:auto; display: block;"></code>
    </div>


</body>
</html>
